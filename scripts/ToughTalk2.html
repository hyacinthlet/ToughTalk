<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>嗯聊2.0</title>
		<style>
			* {
				font-family: "微软雅黑";
			}
			
			input, textarea {
				display: inline-block;
				box-sizing: border-box;
				margin: 0 10px 10px 0;
				padding: 6px 12px;
				line-height: 26px;
				border: #999 1px solid;
				border-radius: 9px;
				background-color: #fff;
				color: #999;
				font-size: 18px;
				outline: none;
				transition: all 0.3s;
				outline: none;
			}
			input[type="text"] {
				width: 300px;
				height: 40px;
			}
			input[type="number"] {
				width: 100px;
				height: 40px;
			}
			input[type="file"] {
				margin: 0 0 14px;
				padding: 0;
				width: 100%;
				border: none;
				border-radius: 0;
				background-color: none;
			}
			textarea {
				width: 100%;
				height: 120px;
				resize: none;
			}
			input:focus, textarea:focus {
				border-color: #fb2;
				color: #666;
			}
			.scroll_container {
				overflow-x: hidden;
				overflow-y: scroll;
			}
			.scroll_container::-webkit-scrollbar {
				width: 16px;
				border: none;
				border-radius: 8px;
				background-color: #fff;
			}
			.scroll_container::-webkit-scrollbar-thumb {
				border-radius: 8px;
				background-color: #666;
			}
			
			#container, #picture_preview {
				box-sizing: border-box;
				margin: 0 auto 500px;
				width: 800px;
				overflow: visible;
				position: relative;
			}
			#container_content {
				background-color: #eee;
				width: 800px;
				min-height: 600px;
				position: relative;
			}
			#container[type="limited"] #container_content {
				width: 816px;
				height: 1400px;
				overflow-y: scroll;
			}
			#container_content> div {
				box-sizing: border-box;
				width: 800px;
				padding: 40px 0;
			}
			#container[type="limited"] #container_content> div {
				padding-top: 80px;
			}
			#container_head {
				display: none;
				width: 800px;
				height: 100px;
				font-size: 24px;
				line-height: 100px;
				letter-spacing: 1px;
				text-align: center;
				background-color: #fffb;
				position: absolute;
				top: 0;
			}
			#container[type="limited"] #container_head {
				display: initial;
				width: 804px;
			}
			.item {
				box-sizing: border-box;
				margin: 20px 30px;
				min-width: 20px;
				border: #fff0 2px solid;
				position: relative;
				letter-spacing: 1px;
				transition: 0.2s all;
			}
			.item[side="right"] {
				text-align: right;
			}
			.item:hover {
				border-color: #fff;
			}
			.item[selected] {
				border-color: #fb2;
			}
			
			.talk_icon {
				display: inline-block;
				box-sizing: border-box;
				width: 80px;
				height: 80px;
				background-color: #fff;
				border-radius: 60px;
				position: absolute;
			}
			.item[side="right"]> .talk_icon {
				right: 0px;
			}
			.talk_name {
				display: inline-block;
				height: 24px;
				color: #666;
				font-weight: bold;
				font-size: 18px;
				line-height: 24px;
				position: absolute;
				top: 6px;
			}
			.item[side="left"]> .talk_name {
				left: 106px;
			}
			.item[side="right"]> .talk_name {
				right: 106px;
			}
			.talk_prefix {
				display: inline-block;
				width: 10px;
				height: 10px;
				border-radius: 2px;
				background-color: #999;
				transform: rotateZ(45deg);
				position: absolute;
				top: 52px;
			}
			.item[side="left"]> .talk_prefix {
				left: 94px;
			}
			.item[side="right"]> .talk_prefix {
				right: 94px;
				background-color: #8298b0;
			}
			.talk_container {
				display: inline-block;
				box-sizing: border-box;
				max-width: 100%;
				vertical-align: text-top;
				position: relative;
			}
			.talk_container> div {
				display: inline-block;
				box-sizing: border-box;
				max-width: 100%;
			}
			.talk_container> div:not(:first-of-type):not([style]) {
				margin-top: 8px;
			}
			.talk_container> div[bubble] {
				background-color: #ccc;
				border-radius: 8px;
				padding: 8px 16px;
			}
			.item[side="right"]> .talk_container> div[bubble] {
				background-color: #bcd;
			}
			.item[side="left"]> .talk_container {
				padding: 34px 100px 0 98px;
				text-align: left;
			}
			.item[side="right"]> .talk_container {
				padding: 34px 98px 0 100px;
				text-align: right;
			}
			.item[side="right"]> .talk_container> div> * {
				text-align: left;
			}
			.item[side="mid"]> .talk_container {
				padding: 0 80px;
				width: 100%;
				text-align: center; 
				color: #666;
			}
			.talk_container> div> * {
				display: inline-block;
				box-sizing: content-box;
				max-width: 100%;
				font-size: 24px;
				line-height: 30px;
				vertical-align: top;
				word-break: break-all;
			}
			.talk_container *[content-type="text"] {
				min-width: 20px;
				min-height: 30px;
			}
			.talk_container *[content-type="image"] {
				min-width: 50px;
				min-height: 50px;
				max-height: 500px;
				border: none;
				border-radius: 8px;
			}
			.talk_container *[content-type="audio"] {
				margin: -4px 0;
				padding-right: 6px;
				max-width: 100%;
				overflow-y: hidden;
			}
			.talk_container *[content-type="audio_translate"] {
				display: inline-block;
				min-width: 20px;
				min-height: 30px;
				margin-right: auto;
				color: #0006;
			}
			.talk_container *[content-type="audio"] div {
				display: inline-block;
				margin: 0 3px;
				width: 3px;
				border-radius: 3px;
				height: 100px;
				background-color: #fff;
				vertical-align: middle;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 1) {
				height: 10px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 2) {
				height: 16px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 3) {
				height: 24px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 4) {
				height: 16px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 5) {
				height: 22px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 6) {
				height: 36px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 7) {
				height: 20px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 8) {
				height: 14px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 9) {
				height: 8px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 10) {
				height: 6px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n + 11) {
				height: 14px;
			}
			.talk_container *[content-type="audio"] div:nth-child(12n) {
				height: 24px;
			}
			
			#control {
				box-sizing: border-box;
				padding: 30px;
				border: #999 2px solid;
				border-radius: 16px;
				background-color: #fffb; 
				box-shadow: #aaa 0 0 20px;
				font-size: 20px;
				position: fixed;
				top: 80px;
				left: 80px;
				user-select: none;
				transition: width 0.3s, height 0.3s;
			}
			#control[type="0"] {
				width: 10px;
				height: 10px;
			}
			#control[type="0"] #debug_panel {
				display: none;
			}
			#control[type="1"] {
				width: 600px;
				height: 800px;
			}
			#control[type="2"] {
				width: 1200px;
				height: 900px;
			}
			#control h3 {
				padding-left: 8px;
				border-left: #fb2 8px solid;
				font-size: 20px;
			}
			#control p {
				
			}
			#control_container {
				box-sizing: border-box;
				width: 100%;
				height: 100%;
				padding-right: 6px;
				padding-bottom: 260px;
				overflow-x: hidden;
				overflow-y: scroll;
			}
			#control[type="0"] #control_container {
				width: 0;
				height: 0;
				padding: 0;
			}
			#control_container h3> button {
				margin-left: 10px;
				width: 24px;
				height: 24px;
				border: none;
				border-radius: 24px;
				background-color: #fb2;
				font-weight: bold;
				cursor: pointer;
			}
			.button_list {
				display: inline-block;
				list-style: none;
				margin: 0;
				padding: 0;
			}
			.button_list li {
				float: left;
				margin: 0 10px 10px 0;
				padding: 6px 12px;
				height: 26px;
				line-height: 26px;
				border: #fb2 1px solid;
				border-radius: 9px;
				background-color: #fff;
				text-align: center;
				overflow: hidden;
				cursor: pointer;
				transition: all 0.3s;
			}
			.button_list li:hover, .button_list li[selected] {
				background-color: #fb2;
			}
			.char_case {
				list-style: none;
				margin: 0;
				padding: 0;
				width: 100%;
			}
			.char_case li {
				display: inline-block;
				margin-bottom: 10px;
				width: 120px;
				text-align: center;
				overflow: hidden;
			}
			.char_case img {
				box-sizing: border-box;
				width: 100px;
				height: 100px;
				border: #fff0 2px solid;
				border-radius: 100px;
				cursor: pointer;
			}
			.char_case li[selected] img {
				border-color: #fb2;
			}
			.char_case li p {
				margin: 0 auto;
				width: max-content;
			}
			.image_case {
				list-style: none;
				margin: 0;
				padding: 0;
				width: 100%;
			}
			.image_case li {
				display: inline-block;
				margin-bottom: 10px;
				width: 120px;
				text-align: center;
				overflow: hidden;
			}
			.image_case img {
				box-sizing: border-box;
				width: 100px;
				height: 100px;
				border: #fff0 2px solid;
				cursor: pointer;
			}
			.image_case li[selected] img {
				border-color: #fb2;
			}
			.image_case li p {
				margin: 0 auto;
				width: max-content;
			}
			
			#splash_introduction {
				height: 280px;
				padding-top: 0;
				color: #555;
				background: none;
				opacity: 0;
				position: fixed;
				top: 200px;
				user-select: none;]
				left: 50%;
				right: 50%;
				overflow-x: visible;
				word-break: keep-all;
				transform: translateX(50%);
				pointer-events: none;
			}
			#splash_introduction p:first-of-type {
				font-size: 180px;
			}
			#splash_introduction p:last-of-type {
				font-size: 60px;
			}
			#splash_introduction[stage="1"] {
				opacity: 1;
				top: 40px;
				transition: all 2s;
			}
			#splash_introduction[stage="1"] p:first-of-type {
				font-size: 120px;
				transition: all 2s;
			}
			#splash_introduction[stage="1"] p:last-of-type {
				font-size: 40px;
				transition: all 2s;
			}
			#splash_introduction[stage="2"] {
				padding-top: 40px;
				opacity: 0;
				top: -200px;
				transition: all 3s, opacity 1s;
			}
			#splash_introduction[stage="2"] p:first-of-type {
				font-size: 60px;
				transition: all 3s;
			}
			#splash_introduction[stage="2"] p:last-of-type {
				font-size: 20px;
				transition: all 3s;
			}
		</style>
		<script>
			var database = null;
			var control_panel = null;
			var output_tool = null;
			var publicity_tool = null;
			const download_prefix = "el2";
			window.onload = function() {
				let data_container = document.getElementById("database");
				database = new d_Database();
				control_panel = new d_ControlPanel(document.getElementById("control"));
				output_tool = new d_HTML2Canvas();
				publicity_tool = new d_VersionPublicity();
				// database.importData();
				// console.log(database.getRecord("talk_character", 1, 1, false));
				// console.log(database.getRecord("talk_character", 1, 1, true));
				// console.log(database.getAllRecord("test"));
				// console.log(database.getAllRecord("test2", true));
				// console.log(database.getRecord("test2", 3, 1));
				// database.removeRecord("test2", 2, 1);
				// console.log(database.getRecord("test2", 3, 1));
				// database.addRecord("test2", [10, 8, "add"]);
				// console.log(database.getAllRecord("test2"));
				// console.log(database.getRecord("test2", 8, 1));
				// database.setRecordIndex("test2", 4, 0);
				// console.log(database.getAllRecord("test2", true));
				// database.storeData();
				// database.loadData(data_container.innerText);
			}
			// 数据库
			class d_Database {
				// 调试信息输出开关
				static debug_mode = false;
				
				// 数据文本分割字符串
				static split_symbol = "/&";
				
				// 数据库版本
				static version = "2";
				
				// 表
				#table = null;
				
				// 上次将数据存到localStorage的时间
				#lastSaveTime = "未保存";
				
				// 实例化对象后，先建立一个带表的空数据库，以便用户开始新作品的编辑
				constructor() {
					this.#constructEmpty();
				}
				
				// 建立一个带表的空数据库
				#constructEmpty() {
					let data = [
						["character", 3,  0, 0, 0],
						["talk", 4,  0, 0, 0, 0],
						["talk_character", 2,  0, 1]
					];
					for (let i = 0; i < data.length; ++i) {
						data[i] = data[i].join(d_DatabaseTable.split_symbol);
					}
					data = d_Database.version + d_Database.split_symbol + data.join(d_Database.split_symbol);
					this.importData(data);
				}
				
				// 从字符串中提取数据信息
				importData(data) {
					if (data == null || data.length == 0) {
						this.debugLogError("载入数据失败：空数据");
						return;
						// data = [
						// 	["character", 3,  0, 0, 0,  1, "1.png", "芬吸员",  2, "3.png", "铸币安卡"],
						// 	["talk", 4,  0, 0, 0, 0,  1, 7, "嗯嗯", 4,  2, 3, "22222222222222222222222222222222222222222222222222", 0,  3, 1, "第2222222222222222222222222222222222222222222222222222222222条", 0,  4, 1, "", 0],
						// 	["talk_character", 2,  0, 1,  1, 1,  2, 1,  3, 2,  4, 1],
						// 	// ["test", 4,  0, 0, 0, 0,  1, 1, "好啊", 0,  1, 1, "嗯嗯", 0],
						// 	// ["test2", 3,  0, 1, 0,  1, 1, "aa",  1, 2, "bb",  3, 2, "cc",  4, 3, "dd"]
						// ];
						// for (let i = 0; i < data.length; ++i) {
						// 	data[i] = data[i].join(d_DatabaseTable.split_symbol);
						// }
						// data = d_Database.version + d_Database.split_symbol + data.join(d_Database.split_symbol);
					}
					let str_data = data.split(d_Database.split_symbol);
					if (str_data.length == 0) {
						this.debugLogError("载入数据失败：数据格式有误");
						return;
					}
					if (d_Database.debug_mode) {
						this.debugLog("数据版本: " + str_data[0]);
					}
					if (str_data[0] != d_Database.version) {
						this.debugLogError("载入数据失败：数据版本不匹配");
						return;
					}
					this.#table = new Array();
					for (let i = 1; i < str_data.length; ++i) {
						let table = new d_DatabaseTable();
						// 数据有误，立即清空数据库
						if (!table.importData(str_data[i])) {
							this.#constructEmpty();
							this.debugLogError("载入数据失败：数据有误");
							return;
						}
						this.#table.push(table);
					}
					if (d_Database.debug_mode) {
						this.debugLog("加载共" + this.#table.length + "张表");
						// console.dir(this.#table);
					}
					
					// id为database的dom元素是开启debug后，用于展示数据库内容的
					document.getElementById("database").innerText = data;
				}
				
				// 从文件中导入数据
				importDataFromFile(that) {
					var file = that.files[0];
					
					// 如果不是txt，就无法解析
					if (file == null || file.name.substr(file.name.lastIndexOf('.') + 1) != "txt") {
						this.debugLogError("文件格式有误");
						return;
					}
					var reader = new FileReader();
					reader.readAsText(file);
					reader.onload = function() {
						// 使用txt内文本进行数据库构建
						database.importData(reader.result);
						that.value = null;
						
						// 构建完成后，刷新试图
						control_panel.loadData();
					}
				}
				
				// 将数据以文本形式导出，这些导出的数据符合导入的数据格式
				exportData() {
					let data = d_Database.version;
					for (let i = 0; i < this.#table.length; ++i) {
						data += d_Database.split_symbol + this.#table[i].exportData();
					}
					let link = document.createElement("a");
					link.download = download_prefix + "Data" + new Date().getTime();
					link.href = "data:text/plain;charset=utf-8," + data;
					link.click();
					link.remove();
				}
				
				// 从表数组中找到指定名字的表，使用遍历方法
				#getTable(table_name) {
					for (let i = 0; i < this.#table.length; ++i) {
						if (this.#table[i].name == table_name) {
							return this.#table[i];
						}
					}
					return null;
				}
				
				// 获得表的主键计数器
				// 如果要保证表主键不重复，需要在调用后手动给结果+1
				getPrimaryKeyCount(table_name) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return -1;
					}
					return table.getPrimaryKeyCount();
				}
				
				// 获取指定表中指定键名的记录，返回一个数组
				// 其中key_id指明外键的编号，如果为零或小于零代表是主键
				getRecord(table_name, key, key_id) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return null;
					}
					return table.getRecord(key, key_id);
				}
				
				// 获取指定表的所有记录，返回一个二维数组
				getAllRecord(table_name) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return null;
					}
					return table.getAllRecord();
				}
				
				// 变更某表记录的数据，如果无法根据key和key_id找到记录，则不做操作
				setRecord(table_name, key, key_id, data) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return null;
					}
					return table.setRecord(key, key_id, data);
				}
				
				// 设置记录的顺序
				// 比如在调整聊天消息的顺序时，需要调整记录的顺序，下次读入的顺序也会变更
				setRecordIndex(table_name, key, index) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return null;
					}
					return table.setRecordIndex(key, index);
				}
				
				// 增加一条记录
				addRecord(table_name, data) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return;
					}
					table.addRecord(data);
				}
				
				// 移出一条记录
				removeRecord(table_name, key, key_id) {
					let table = this.#getTable(table_name);
					if (table == null) {
						return;
					}
					table.removeRecord(key, key_id);
				}
				
				// 将数据存到localStorage中
				storeData() {
					let data_container = document.getElementById("database");
					let data = d_Database.version;
					for (let i = 0; i < this.#table.length; ++i) {
						data += d_Database.split_symbol + this.#table[i].exportData();
					}
					if (d_Database.debug_mode) {
						this.debugLog("已存档：" + new Date());
					}
					
					data_container.innerText = data;
					localStorage.setItem("el_data", data);
					let date = new Date();
					this.#lastSaveTime = date.getHours().toString().padStart(2, '0') + ":" + date.getMinutes().toString().padStart(2, '0') + ":" + date.getSeconds().toString().padStart(2, '0');
					control_panel.updateTip();
				}
				getLastSaveTime() {
					return this.#lastSaveTime;
				}
				debugLog(str) {
					console.log("[Database] " + str);
				}
				debugLogError(str) {
					console.error("[Database] " + str);
				}
			}
			
			// 数据库表
			class d_DatabaseTable {
				static split_symbol = "&&";
				
				// 表名
				name = null;
				
				// 字段，使用key_id遍历字段确定外键所在列
				// key_id > 0 means key, first column means main key
				#field = null;
				
				// 记录
				#record = null;
				
				// 外键映射表，通过外键key_id可以映射到所有的主键
				#key_map = null;
				
				// 表大小
				#size = null;
				
				// 主键计数器，只计算目前主键的最大值
				// 主键必须是数字
				#primaryKeyCount = null;
				
				// 从文本中提取数据信息
				importData(data) {
					if (data == null || data.length == 0) {
						return false;
					}
					data = data.split(d_DatabaseTable.split_symbol);
					if (data.length < 2) {
						return false;
					}
					
					// 第一段数据是表名
					this.name = data[0];
					
					// 第二段是字段数，确保是合法数字
					let temp_number = parseInt(data[1]);
					if (isNaN(temp_number) || temp_number < 0) {
						return false;
					}
					this.#size = {
						field_count: temp_number,
						record_count: 0,
						total: 0
					};
					let field_count = this.#size.field_count;
					let record_count = parseInt((data.length - field_count - 2) / this.#size.field_count);
					
					// 通过字段数和记录数推断数据长度是否合法
					if (data.length != 2 + field_count * (record_count + 1)) {
						return false;
					}
					
					// 数据合法，开始添加字段标记和记录
					this.#field = new Array(field_count);
					this.#record = new Map();
					this.#key_map = new Map();
					let offset = 2;
					for (let i = 0; i < field_count; ++i) {
						temp_number = parseInt(data[offset + i])
						if (isNaN(temp_number)) {
							return false;
						}
						this.#field[i] = temp_number;
					}
					offset += field_count;
					let len = record_count;
					for (let i = 0, j = 0; i < len; ++i) {
						let _arr = new Array(field_count);
						for (j = 0; j < field_count; ++j) {
							_arr[j] = data[offset + j];
						}
						this.addRecord(_arr);
						offset += this.#size.field_count;
					}
					
					if (d_Database.debug_mode) {
						database.debugLog("表" + this.name + "加载完毕，共" + this.#size.total + "项");
					}
					return true;
				}
				
				// 将表数据以文本形式导出，导出数据符合导入格式
				exportData() {
					let split_symbol = d_DatabaseTable.split_symbol;
					let data = this.name + split_symbol + this.#size.field_count;
					data += split_symbol + this.#field.join(d_DatabaseTable.split_symbol);
					let _record = this.getAllRecord();
					if (Array.isArray(_record[0])) {
						for (let i = 0; i < _record.length; ++i) {
							_record[i] = _record[i].join(d_DatabaseTable.split_symbol);
						}
					}
					data += split_symbol + _record.join(d_DatabaseTable.split_symbol);
					return data;
				}
				
				// 通过外键id和外键名查找对应的主键有什么
				// key_id 不大于0表示这就是主键，会检查主键合法性：是否是合法数字，是否存在
				getPrimaryKey(key, key_id) {
					key_id = parseInt(key_id);
					// 外键转主键
					if (key_id != null && key_id > 0) {
						key = key.toString();
						if (!this.#key_map.has(key_id)) {
							return null;
						}
						let id_map = this.#key_map.get(key_id);
						if (!id_map.has(key)) {
							return null;
						}
						key = id_map.get(key);
					}
					// 主键必须是数字
					else {
						key = parseInt(key);
						if (!this.#record.has(key)) {
							return null;
						}
					}
					// 结果既不是数字，也不是通过外键找到的主键数组，说明键非法
					if (isNaN(key) && !Array.isArray(key)) {
						return null;
					}
					return key;
				}
				
				// 获得主键在记录中的顺序下标
				// 因为不一定是顺序序列，所以通过顺序遍历查找
				getPrimaryKeyIndex(key) {
					key = this.getPrimaryKey(key, 0);
					if (key == null) {
						return -1;
					}
					let index = 0;
					let keys = this.#record.keys();
					for (let item of keys) {
						if (item == key) {
							break;
						}
						++index;
					}
					return index;
				}
				
				// 获得当前所有主键的最大数，将其+1后防止主键重复
				getPrimaryKeyCount() {
					if (this.#primaryKeyCount == null) {
						return 1;
					}
					return this.#primaryKeyCount;
				}
				
				// 通过键查找记录
				getRecord(key, key_id) {
					// 将键转主键
					key = this.getPrimaryKey(key, key_id);
					
					// 键不存在
					if (key == null) {
						return null;
					}
					let res = new Array();
					let value = null;
					
					// 如果是通过外键查找，可能会得到多个主键
					if (Array.isArray(key)) {
						for (let i = 0; i < key.length; ++i) {
							value = this.getRecord(key[i], 0);
							if (Array.isArray(value[0])) {
								for (let j = 0; j < value.length; ++j) {
									res.push(value[j]);
								}
							}
							else {
								res.push(value);
							}
						}
						return res;
					}
					// 如果是通过外键查找，可能会得到一个主键
					// 用主键查找，仅允许一个主键
					else {
						value = this.#record.get(key);
					}
					if (value == null) {
						return null;
					}
					
					// 如果主键对应的记录有多条，将它们拆散开来
					if (Array.isArray(value[0])) {
						for (let i = 0; i < value.length; ++i) {
							let arr = new Array();
							arr.push(key);
							for (let j = 0; j < value[i].length; ++j) {
								arr.push(value[i][j]);
							}
							res.push(arr);
						}
					}
					// 否则直接加上主键构成完整记录返回
					else {
						res.push(key);
						for (let i = 0; i < value.length; ++i) {
							res.push(value[i]);
						}
					}
					return res;
				}
				
				// 获取所有记录，没什么好说的
				getAllRecord() {
					let keys = this.#record.keys();
					let res = new Array();
					for (let key of keys) {
						let value = this.getRecord(key, 0);
						
						// 主键对应记录有多条，将它们拆散
						if (Array.isArray(value[0])) {
							for (let j = 0; j < value.length; ++j) {
								res.push(value[j]);
							}
						}
						else {
							res.push(value);
						}
					}
					return res;
				}
				
				// 变更指定单个主键对应的记录
				// key必须是主键查找，并且data不包含主键
				setRecord(key, data) {
					if (data == null || data.length != this.#size.field_count - 1) {
						return;
					}
					
					// 检查主键合法性
					key = this.getPrimaryKey(key);
					if (key == null) {
						return;
					}
					if (Array.isArray(key)) {
						return;
					}
					let clone_data = Array.from(data);
					for (let i = 0; i < clone_data.length; ++i) {
						// 除主键外的数据都是字符串储存
						clone_data[i] = clone_data[i].toString();
					}
					let former_data = this.#record.get(key);
					for (let i = 0; i < clone_data.length; ++i) {
						if (this.#field[i + 1] <= 0) {
							continue;
						}
						if (former_data[i] == clone_data[i]) {
							continue;
						}
						// 如果外键变化，更改对应的键图
						let foreign_key = former_data[i];
						// 将原先外键对应的主键（数组）移除
						this.#removeForeignKey(foreign_key, this.#field[i + 1]);
						// 再将新外键记录
						this.#addForeignKey(clone_data[i], this.#field[i + 1], key);
					}
					this.#record.set(key, clone_data);
				}
				
				// 设置主键的顺序下标，没什么好说的
				setRecordIndex(key, new_index) {
					key = this.getPrimaryKey(key, 0);
					if (key == null) {
						return null;
					}
					let item_index = this.getPrimaryKeyIndex(key);
					
					if (new_index == "last") {
						new_index = this.#size.record_count - 1;
					}
					else if (new_index < 0) {
						new_index = 0;
					}
					else if (new_index >= this.#size.record_count) {
						new_index = this.#size.record_count - 1;
					}
					if (item_index == new_index) {
						return;
					}
					
					let new_map = new Map();
					for (let item of this.#record.keys()) {
						if (new_index == 0) {
							new_map.set(key, this.#record.get(key));
						}
						if (key != item) {
							new_map.set(item, this.#record.get(item));
							--new_index;
						}
					}
					if (new_index == 0) {
						new_map.set(key, this.#record.get(key));
					}
					this.#record = new_map;
				}
				
				// 增加一条记录，这条记录必须完整，包含主键和所有字段数据
				addRecord(data) {
					if (d_Database.debug_mode) {
						database.debugLog("添加数据：" + data);
					}
					if (data == null || data.length != this.#size.field_count) {
						database.debugLogError("添加数据失败：数据格式错误");
						return;
					}
					let key = parseInt(data[0]);
					if (isNaN(key)) {
						database.debugLogError("添加数据失败：数据ID错误");
						return;
					}
					
					// 更新主键计数器
					if (this.#primaryKeyCount == null) {
						this.#primaryKeyCount = key;
					}
					else if (this.#primaryKeyCount < key) {
						this.#primaryKeyCount = key;
					}
					
					let clone_data = data.slice(1);
					for (let i = 0; i < clone_data.length; ++i) {
						clone_data[i] = clone_data[i].toString();
					}
					
					let value = null;
					// 如果已经存在主键，就新建一个数据存放主键数据
					if (this.#record.has(key)) {
						let t_value = this.#record.get(key);
						value = new Array();
						value.push(t_value);
						value.push(clone_data);
					}
					else {
						value = clone_data;
					}
					this.#record.set(key, value);
					
					// 更新表大小
					++this.#size.record_count;
					this.#size.total += this.#size.field_count;
					for (let i = 0; i < clone_data.length; ++i) {
						if (this.#field[i + 1] <= 0) {
							continue;
						}
						// 如果是外键，就加入记录
						this.#addForeignKey(clone_data[i], this.#field[i + 1], key);
					}
				}
				
				// 通过外键key_id和键名foreign_key找到指定外键，为其添加一条主键映射
				#addForeignKey(foreign_key, key_id, primary_key) {
					key_id = parseInt(key_id);
					if (!this.#key_map.has(key_id)) {
						this.#key_map.set(key_id, new Map());
					}
					
					// 映射表首先通过key_id确定外键的列，再通过key键名确定外键的行
					let id_map = this.#key_map.get(key_id);
					let value = null;
					if (id_map.has(foreign_key)) {
						value = id_map.get(foreign_key);
						if (!Array.isArray(value)) {
							value = new Array();
							value.push(id_map.get(foreign_key));
						}
						value.push(primary_key);
					}
					else {
						value = primary_key;
					}
					id_map.set(foreign_key, value);
					this.#key_map.set(key_id, id_map);
				}
				
				// 移除一个外键
				#removeForeignKey(foreign_key, key_id) {
					key_id = parseInt(key_id);
					let id_map = this.#key_map.get(key_id);
					id_map.delete(foreign_key);
					// let value = id_map.get(foreign_key);
					// if (Array.isArray(value)) {
					// 	for (let i = 0; i < value.length; ++i) {
					// 		if (value[i] == key) {
					// 			value.splice(i, 1);
					// 			break;
					// 		}
					// 	}
					// 	if (value.length == 1) {
					// 		value = value[0];
					// 	}
					// 	id_map.set(foreign_key, value);
					// }
					// else {
					// 	id_map.delete(foreign_key);
					// }
					this.#key_map.set(key_id, id_map);
				}
				
				// 通过键移除一个记录
				removeRecord(key, key_id) {
					key = this.getPrimaryKey(key, key_id);
					if (key == null) {
						return null;
					}
					
					// 如果得到的是一个主键序列，就递归一次进行删除
					if (Array.isArray(key)) {
						for (let i = 0; i < key.length; ++i) {
							this.removeRecord(key[i], 0);
						}
					}
					else {
						let value = this.#record.get(key);
						let count = 1;
						
						// 主键对应有多条记录
						if (Array.isArray(value[0])) {
							count = value.length;
							for (let i = 1; i < this.#field.length; ++i) {
								// 如果字段大于0，表明这是外键，需要删除主键映射
								if (this.#field[i] <= 0) {
									continue;
								}
								for (let j = 0; j < value.length; ++j) {
									this.#removeForeignKey(value[j][i - 1], this.#field[i]);
								}
							}
						}
						for (let i = 0; i < value.length; ++i) {
							// 如果字段大于0，表明这是外键，需要删除主键映射
							if (this.#field[i + 1] > 0) {
								this.#removeForeignKey(value[i], this.#field[i + 1]);
							}
						}
						this.#record.delete(key);
						this.#size.record_count -= count;
						this.#size.total -= count * this.#size.field_count;
					}
				}
			}
			
			// 控制面板
			class d_ControlPanel {
				// 调试信息输出
				static debug_mode = false;
				
				// dom元素本体
				#object = null;
				
				// 为3.0做准备
				#panel = [];
				
				// 页面视图
				#view_panel = null;
				
				// 角色展柜
				#character_container = null;
				
				// 选中角色的顺序下标
				#select_character_index = -1;
				
				// 选中角色的数据
				#select_character_data = ["", "", ""];
				
				// 可编辑区域
				#edit_area = [null, null, null, null, null];
				
				// 图片预览区域
				#preview_area = [null, null];
				
				// 面板拖拽信息
				#drag_data = null;
				
				constructor(_object) {
					this.#object = _object;
					this.#view_panel = new d_ViewPanel(document.getElementById("container_content").children[0]);
					this.#character_container = new d_RadioPanel(document.getElementById("char_case"));
					this.#edit_area = [
						document.getElementById("data_item_type_input"),
						document.getElementById("data_char_path_input"),
						document.getElementById("data_char_name_input"),
						document.getElementById("data_text_input"),
						document.getElementById("data_image_path_input"),
						document.getElementById("data_size_input")
					];
					this.#edit_area[0] = new d_RadioPanel(this.#edit_area[0]);
					this.#edit_area[0].relateToRear(true);
					this.#edit_area[0].selectItem(0);
					this.#preview_area = [
						this.#edit_area[1].nextElementSibling,
						this.#edit_area[5].nextElementSibling
					];
					let drag_bean = this.#object.children[0];
					let panel = this;
					drag_bean.ondragstart = function(event) {
						panel.#drag_data = {
							cx: event.clientX,
							cy: event.clientY,
							ix: panel.#object.offsetLeft,
							iy: panel.#object.offsetTop
						};
					};
					drag_bean.ondrag = function(event) {
						panel.dragPanel();
					};
					drag_bean.ondragend = function(event) {
						panel.dragPanel();
					};
					drag_bean.onclick = function(event) {
						panel.resizePanel();
					};
					this.updatePreviewUI();
				}
				
				// 没用，也别用
				loadTemplate(panel_index, id, data) {
					while (this.#panel.firstChild) {
						this.#panel.lastChild.remove();
					}
					let templates = document.getElementById("template");
					if (Array.isArray(id)) {
						for (let i = 0; i < id.length; ++i) {
							let item = templates.children[id[i]].cloneNode();
							setTemplateData(item, data[i]);
							this.#panel[panel_index].appendChild(item);
						}
					}
					else {
						let item = templates.children[id].cloneNode();
						setTemplateData(item, data);
						this.#panel[panel_index].appendChild(item);
					}
				}
				
				// 加载数据，先全部清空再加载
				loadData() {
					this.clear();
					this.listAllCharacter();
					this.#view_panel.listAll();
				}
				
				// 增加一条消息
				addItem() {
					this.#view_panel.addItem(null, true);
				}
				
				// 移除一条消息
				removeItem() {
					this.#view_panel.removeItem(true);
				}
				
				// 选中一条消息
				selectItem(that) {
					let data = this.#view_panel.selectItem(that);
					let box = document.getElementById("char_case");
					let char_id = this.#view_panel.getCharacterData()[0];
					
					// 向渲染器传递参数
					setSelectItemIndex(this.#view_panel.getSelectItemIndex());
					
					// 更新UI：角色展柜自动选中消息发送人
					let item = null;
					for (let i = 0; i < box.childElementCount; ++i) {
						let id = box.children[i].getAttribute("database-id");
						if (char_id != id) {
							continue;
						}
						item = box.children[i];
						break;
					}
					
					// 更新UI：可编辑区域与消息数据进行同步
					if (!this.selectCharacter(item, false) && data != null) {
						for (let i = 0; i < data.length; ++i) {
							this.setUIData(i, data[i]);
						}
					}
					
					// 更新UI：可编辑区域与消息数据进行同步
					this.updateTip();
				}
				
				// 获取选中消息的顺序下标
				getSelectItemIndex() {
					return this.#view_panel.getSelectItemIndex();
				}
				
				// 清空选择
				clearSelect() {
					this.#view_panel.selectItem(null);
					this.#select_character_index = -1;
					this.#select_character_data[0] = -1;
					this.updateTip();
				}
				
				// 设置消息类型
				setItemType(that, type) {
					this.#view_panel.setItemType(type, true);
					this.setUIData(0, type);
				}
				
				// 没用
				getItemData(data) {
					
				}
				
				// 设置消息数据
				setItemData(data) {
					this.#view_panel.setItemData(data, true);
					let _data = this.#view_panel.getSelectItemData(false);
					for (let i = 0; i < _data.length; ++i) {
						this.setUIData(i, _data[i]);
					}
					this.updatePreviewUI();
				}
				
				// 移动消息位置
				changeItemIndex(offset) {
					this.#view_panel.changeItemIndex(offset, true);
				}
				
				// 新增一个角色
				// 如果这是database在读取数据，need_store就是false，表示不需要储存到数据库
				// 如果是用户操作，就需要need_store置为true
				addCharacter(data, need_store) {
					// 有新角色，就把没有角色的提示撤掉
					this.#character_container.getObject().parentNode.children[0].style.display = "none";
					
					// 如果data是null，就使用之前修改的数据
					// 这种情况就是用户新增
					if (data == null) {
						data = this.#select_character_data.slice(0);
					}
					let index = this.#character_container.getCount();
					let img = document.createElement("img");
					img.setAttribute("onclick", "control_panel.selectCharacter(this.parentNode, true)");
					if (data[1] != null) {
						img.src = './img/' + data[1];
					}
					let p = document.createElement("p");
					if (data[2] != null) {
						p.innerText = data[2];
					}
					else {
						p.innerText = "未命名";
					}
					let li = document.createElement("li");
					li.appendChild(img);
					li.appendChild(p);
					
					// 角色展柜新增一个角色
					this.#character_container.addItem(li, index);
					if (need_store) {
						// 主键自增
						let count = database.getPrimaryKeyCount("character") + 1;
						data[0] = count;
						li.setAttribute("database-id", count);
						database.addRecord("character", data);
						this.selectCharacter(li, false);
					}
					else {
						li.setAttribute("database-id", data[0]);
					}
					
				}
				
				// 移除一个角色
				// 标识是否需要数据库同步操作
				removeCharacter(need_store) {
					let index = this.#select_character_index;
					if (index < 0) {
						return;
					}
					this.#character_container.removeItem(index);
					if (need_store) {
						database.removeRecord("character", this.#select_character_data[0]);
						database.storeData();
						this.#view_panel.updateItemCharacterData(this.#select_character_data[0]);
					}
					this.#select_character_index = -1;
					this.#select_character_data[0] = -1;
					
					// 如果没有角色，就把提示搬出来
					if (this.#character_container.getCount() == 0) {
						this.#character_container.getObject().parentNode.children[0].style.display = null;
					}
				}
				
				// 选择角色
				// 标识是否需要数据库同步操作
				selectCharacter(that, need_store) {
					// 出bug了？
					if (that == null) {
						this.#select_character_index = -1;
						this.#select_character_data[0] = -1;
						this.#character_container.clearSelect();
						return false;
					}
					this.#select_character_index = this.#character_container.getItemIndex(that);
					let id = that.getAttribute("database-id");
					
					// 重复选中同一角色
					if (id == this.#select_character_data[0]) {
						return false;
					}
					
					// 同步数据
					this.#select_character_data[0] = id;
					this.#select_character_data = database.getRecord("character", this.#select_character_data[0], null);
					
					// 更新UI
					this.#character_container.selectItem(this.#select_character_index);
					let data = this.#view_panel.setCharacterData(this.#select_character_data, need_store);
					if (data.length == 0) {
						this.setUIData(1, this.#select_character_data[1]);
						this.setUIData(2, this.#select_character_data[2]);
					}
					else {
						for (let i = 0; i < data.length; ++i) {
							this.setUIData(i, data[i]);
						}
					}
					this.updatePreviewUI();
					return true;
				}
				
				// 设置角色数据
				// 标识是否需要数据库同步操作
				setCharacterData(data, need_store) {
					let index = this.#select_character_index;
					let item = this.#character_container.getItem(index);
					
					// 更新UI
					if (data[0] != null) {
						this.#select_character_data[1] = data[0];
						if (item != null) {
							item.children[0].src = "./img/" + data[0];
						}
					}
					if (data[1] != null) {
						this.#select_character_data[2] = data[1];
						if (item != null) {
							item.children[1].innerText = data[1];
						}
					}
					this.updatePreviewUI();
					
					// 如果没有选中角色，就说明没在修改现有角色
					if (!this.#character_container.isIndexValid(index)) {
						return;
					}
					if (need_store) {
						database.setRecord("character", this.#select_character_data[0], this.#select_character_data.slice(1));
						database.storeData();
						this.#view_panel.updateItemCharacterData(this.#select_character_data[0]);
					}
				}
				
				// 将所有角色罗列出来，一般在使用前需要先清空角色展柜
				// 因为读数据操作，不需要保存
				listAllCharacter() {
					let data = database.getAllRecord("character");
					for (let i = 0; i < data.length; ++i) {
						this.addCharacter(data[i], false);
					}
				}
				
				// 获取可编辑区域的数据
				// 没用
				getUIData(index) {
					if (index == 0) {
						return null;
					}
					else {
						return this.#edit_area[index].value;
					}
				}
				
				// 设置可编辑区域的数据，用于同步消息数据
				setUIData(index, data) {
					let parent = this.#edit_area[index];
					if (index == 0) {
						parent.selectItem(data - 1);
					}
					else {
						parent.value = data;
					}
				}
				
				// 更新图片预览
				updatePreviewUI() {
					this.#preview_area[0].src = "./img/" + this.#edit_area[1].value;
					this.#preview_area[1].src = "./img/" + this.#edit_area[4].value;
				}
				
				// 清空所有数据
				clear() {
					this.clearSelect();
					this.#character_container.clear();
					this.#view_panel.clear();
				}
				
				// 更新提示
				updateTip() {
					let str = "";
					let index = this.#view_panel.getSelectItemIndex();
					if (index < 0) {
						str = "未在编辑，";
					}
					else {
						str = "正在编辑第" + (index + 1) + "项，";	
					}
					str += "上次保存时间：" + database.getLastSaveTime();
					document.getElementById("debug_panel").innerText = str;
				}
				
				// 拖拽面板
				dragPanel() {
					let pos = {
						x: event.clientX - this.#drag_data.cx + this.#drag_data.ix,
						y: event.clientY - this.#drag_data.cy + this.#drag_data.iy
					}
					if (pos.x <= 0 && pos.y <= 0) {
						return;
					}
					if (pos.x < 10) {
						pos.x = 10;
					}
					else if (pos.x > window.innerWidth - this.#object.offsetWidth - 10) {
						pos.x = window.innerWidth - this.#object.offsetWidth - 10;
					}
					if (pos.y < 10) {
						pos.y = 10;
					}
					else if (pos.y > window.innerHeight - this.#object.offsetHeight - 10) {
						pos.y = window.innerHeight - this.#object.offsetHeight - 10;
					}
					
					if (pos.x < 10) {
						pos.x = 10;
					}
					if (pos.y < 10) {
						pos.y = 10;
					}
					this.#object.style.left = pos.x + "px";
					this.#object.style.top = pos.y + "px";
				}
				
				// 变更面板形态
				resizePanel() {
					let type = this.#object.getAttribute("type");
					++type;
					type %= 3;
					this.#object.setAttribute("type", type);
				}
				debugLog(str) {
					console.log("[ControlPanel] " + str);
				}
				debugLogError(str) {
					console.error("[ControlPanel] " + str);
				}
			}
			
			// 页面视图
			class d_ViewPanel {
				// 调试信息输出开关
				static debug_mode = false;
				
				// 控制面板选中的角色的信息
				#select_character_data = [0, null, null];
				
				// 用于存放消息的容器
				#container = null;
				
				// 选中消息的顺序下标，小于0表示没选中
				#select_item_index = -1;
				
				// 选中消息的数据
				#select_item_data = [-1, 1, "", 0];
				
				// 选中消息的数据转UI同步数据，用于给控制面板显示
				#select_item_data_ui = [1, 1, "", 0];
				constructor(container) {
					this.#container = new d_RadioPanel(container);
				}
				
				// 新增一条消息
				// 标识是否需要数据库同步操作
				addItem(data, need_store) {
					if (data == null) {
						data = this.#select_item_data.slice(0);
					}
					
					// 如果没选中消息，就在末尾追加消息，否则在选中消息的下方插入
					let index = this.#select_item_index;
					if (!this.#container.isIndexValid(index)) {
						index = this.#container.getCount();
					}
					else {
						++index;
					}
					if (d_ViewPanel.debug_mode && need_store) {
						this.debugLog("第" + index + "项插入:" + data);
					}
					
					// 通过消息类型，从模版中copy一个过来
					let item = this.getTemplate(data[1] - 1);
					if (need_store) {
						// 数据库主键自增
						data[0] = database.getPrimaryKeyCount("talk") + 1;
						item.setAttribute("database-id", data[0]);
						this.#container.addItem(item, index);
						database.addRecord("talk", data);
						database.setRecordIndex("talk", data[0], index);
						database.addRecord("talk_character", [data[0], this.#select_character_data[0]]);
						database.storeData();
					}
					else {
						item.setAttribute("database-id", data[0]);
						this.#container.addItem(item, index);
					}
					this.selectItem(item);
					this.setItemData(data.slice(1), false);
					this.clearSelect();
				}
				
				// 移除一条消息
				// 标识是否需要数据库同步操作
				removeItem(need_store) {
					let index = this.#select_item_index;
					if (index < 0) {
						return;
					}
					this.#container.removeItem(index);
					if (need_store) {
						database.removeRecord("talk", this.#select_item_data[0]);
						database.removeRecord("talk_character", this.#select_item_data[0]);
						database.storeData();
					}
					this.#select_item_index = -1;
					this.#select_item_data[0] = -1;
				}
				
				// 选中一条消息
				selectItem(that) {
					let index = this.#container.getItemIndex(that);
					
					// 同一条就取消选中
					if (index < 0 || this.#select_item_index == index) {
						this.clearSelect();
						return;
					}
					this.#select_item_index = index;
					this.#select_item_data[0] = that.getAttribute("database-id");
					this.#select_item_data = database.getRecord("talk", this.#select_item_data[0], 0);
					
					let d_data = database.getRecord("talk_character", this.#select_item_data[0], 0);
					this.#select_character_data[0] = d_data[1];
					d_data = database.getRecord("character", d_data[1], 0);
					if (d_data == null) {
						d_data = [null, null, null];
					}
					this.#select_character_data[1] = d_data[1];
					this.#select_character_data[2] = d_data[2];
					
					// 将消息的数据转化为显示在控制面板UI上的信息
					this.#select_item_data_ui = [
						this.#select_item_data[1],
						this.#select_character_data[1],
						this.#select_character_data[2],
						this.#select_item_data[2],
						this.#select_item_data[2],
						this.#select_item_data[3]
					];
					this.#container.selectItem(this.#select_item_index);
					return this.#select_item_data_ui;
				}
				
				// 取消选中
				clearSelect() {
					this.#container.clearSelect();
					this.#select_item_index = -1;
					this.#select_item_data[0] = -1;
				}
				
				// 设置消息类型
				// 标识是否需要数据库同步操作
				setItemType(type, need_store) {
					let cur_type = this.#select_item_data[1];
					if (type == cur_type) {
						return;
					}
					this.#select_item_data[1] = type;
					this.#select_item_data_ui[0] = type;
					let index = this.#select_item_index;
					if (!this.#container.isIndexValid(index)) {
						return;
					}
					
					// 把以前的删掉，放一个新的进来
					this.#container.removeItem(index);
					let item = this.getTemplate(type - 1);
					item.setAttribute("database-id", this.#select_item_data[0]);
					this.#container.addItem(item, index);
					let data = this.#select_item_data.slice(1);
					this.setItemData(data, false);
					this.#container.selectItem(index);
					if (need_store) {
						database.setRecord("talk", this.#select_item_data[0], data);
						database.storeData();
					}
				}
				
				// 设置消息数据，接受不含key（数据库主键）的数据
				// 标识是否需要数据库同步操作
				setItemData(data, need_store) {
					if (data != null) {
						for (let i = 0; i < data.length; ++i) {
							if (data[i] != null) {
								this.#select_item_data[i + 1] = data[i];
							}
						}
					}
					this.#select_item_data_ui = [
						this.#select_item_data[1],
						this.#select_character_data[1],
						this.#select_character_data[2],
						this.#select_item_data[2],
						this.#select_item_data[2],
						this.#select_item_data[3]
					];
					let index = this.#select_item_index;
					if (!this.#container.isIndexValid(index)) {
						return;
					}
					let t_data = [
						this.#select_character_data[1],
						this.#select_character_data[2],
						this.#select_item_data[2],
						this.#select_item_data[3],
					];
					let item = this.#container.getItem(index);
					// let main_type = item.getAttribute("main-type");
					// if (main_type == "talk") {
						
					// 更新UI
					let div = null;
					div = item.getElementsByClassName("talk_icon")[0];
					if (div != null && t_data[0] != null) {
						div.src = './img/' + t_data[0];
					}
					
					div = item.getElementsByClassName("talk_name")[0];
					if (div != null) {
						div.innerText = t_data[1];
					}
					
					let type = parseInt(item.getAttribute("type"));
					t_data = this.#getComponentData(t_data, type);
					div = item.getElementsByClassName("talk_container")[0];
					for (let loop = 0; loop < div.childElementCount; ++loop) {
						for (let i = 0; i < div.children[loop].childElementCount; ++i) {
							this.#setComponentData(t_data, div.children[loop].children[i]);
						}
					}
					
					// }
					if (need_store) {
						database.setRecord("talk", this.#select_item_data[0], this.#select_item_data.slice(1));
						database.storeData();
					}
				}
				
				// 通过消息类型type和消息数据data获得一份定制的数据
				#getComponentData(data, type) {
					let clone_data = data.slice(0);
					let res = null;
					if (type < 7) {
						res = [clone_data[2], clone_data[3]];
					}
					else if (type < 10) {
						let temp = parseInt(clone_data[3]);
						if (temp < 1) {
							temp = 1;
						}
						else if (temp > 60) {
							temp = 60;
						}
						// let minute = parseInt(temp / 60);
						// let second = temp % 60;
						let str = "";
						// if (minute != 0 && minute != 1) {
						// 	str += minute + "'";
						// }
						// if (second != 0) {
							str += temp + "\"";
						// }
						// else if (minute == 1) {
						// 	str = "60\"";
						// }
						res = [str, temp, clone_data[2]];
					}
					return res;
				}
				
				// 通过定制的数据data，修改消息item的UI数据
				#setComponentData(data, item) {
					let clone_data = data.slice(0);
					let type = item.getAttribute("content-type");
					if (type == "text") {
						item.innerText = clone_data[0];
					}
					else if (type == "image") {
						if (clone_data[0] != null || clone_data[0].trim().length == 0) {
							item.src = "./img/" + clone_data[0];
						}
						else {
							item.src = null;
						}
						if (clone_data[1] < 50) {
							item.style.width = null;
						}
						else {
							item.style.width = clone_data[1] + "px";
						}
					}
					else if (type == "audio") {
						let time = parseInt(clone_data[1]);
						let count = Math.round(8 + (40 - 8) * time / 60);
						for (let i = item.childElementCount; i < count; ++i) {
							item.appendChild(document.createElement("div"));
						}
						while (item.childElementCount > count) {
							item.removeChild(item.lastChild);
						}
					}
					else if (type == "audio_translate") {
						if (clone_data[2] == null || clone_data[2].trim().length == 0) {
							item.parentNode.style.display = "none";
						}
						else {
							item.parentNode.removeAttribute("style");
							item.innerText = clone_data[2];
						}
					}
				}
				
				// 获取选中消息的顺序下标
				getSelectItemIndex() {
					return this.#select_item_index;
				}
				
				// 改变消息的顺序位置
				// 肯定需要数据库同步操作
				changeItemIndex(offset) {
					let index = this.#select_item_index;
					if (index < 0) {
						return;
					}
					let new_index = this.#container.setItemIndex(index, index + offset);
					if (new_index == -1) {
						return;
					}
					this.#select_item_index = new_index;
					database.setRecordIndex("talk", this.#select_item_data[0], new_index);
					database.storeData();
				}
				
				// 获取选中消息的数据
				getSelectItemData(origin) {
					if (!this.#container.isIndexValid(this.#select_item_index)) {
						return [];
					}
					if (origin) {
						return this.#select_item_data.slice(0);
					}
					return this.#select_item_data_ui.slice(0);
				}
				
				// 更新所有消息的角色数据
				// 比如用户改了角色名、删除了角色，都需要更新视图中该角色对应消息的UI
				updateItemCharacterData(char_id) {
					let data = database.getRecord("talk_character", char_id, 1);
					if (data == null) {
						return;
					}
					
					// 获取所有受影响的消息的id
					let _set = new Set();
					for (let i = 0; i < data.length; ++i) {
						if (Array.isArray(data[i])) {
							for (let j = 0; j < data[i].length; ++j) {
								_set.add(data[i][j]);
							}
						}
						else {
							_set.add(data[i]);
						}
					}
					_set.delete(char_id.toString());
					
					// 获取最新的角色信息
					data = database.getRecord("character", char_id, 0);
					if (data == null) {
						data = [null, null, null];
					}
					
					// 将最新消息应用到所有受影响的消息UI上
					for (let i = 0; i < this.#container.getCount(); ++i) {
						let item = this.#container.getItem(i);
						let id = item.getAttribute("database-id");
						id = parseInt(id);
						if (_set.has(id)) {
							_set.delete(id);
							let div = null;
							div = item.getElementsByClassName("talk_icon")[1];
							if (div != null) {
								if (data[1] != null) {
									div.src = './img/' + data[1];
								}
								else {
									div.src = "";
								}
							}
							div = item.getElementsByClassName("talk_name")[0];
							if (div != null) {
								div.innerText = data[2];
							}
						}
					}
				}
				
				// 设置角色数据，用于改变消息发送人
				// 标识是否需要数据库同步操作
				setCharacterData(data, need_store) {
					for (let i = 0; i < data.length; ++i) {
						if (data[i] != null) {
							this.#select_character_data[i] = data[i];
						}
					}
					let index = this.#select_item_index;
					if (index < 0) {
						return [];
					}
					if (need_store) {
						database.setRecord("talk_character", this.#select_item_data[0], [this.#select_character_data[0]]);
						database.storeData();
					}
					this.setItemData(null, false);
					return this.#select_item_data_ui;
				}
				
				// 获取选中消息的角色的数据
				getCharacterData() {
					return this.#select_character_data;
				}
				
				// 列出所有的消息
				listAll() {
					this.clear();
					let data = database.getAllRecord("talk");
					for (let i = 0; i < data.length; ++i) {
						this.addItem(data[i], false);
					}
				}
				
				// 清空数据
				clear() {
					this.clearSelect();
					this.#container.clear();
				}
				
				// 通过消息类型获取模版dom元素
				getTemplate(index) {
					return document.getElementById("template").children[index].cloneNode(true);
				}
				debugLog(str) {
					console.log("[ViewPanel] " + str);
				}
				debugLogError(str) {
					console.error("[ViewPanel] " + str);
				}
			}
			
			// 单选面板
			class d_RadioPanel {
				// 本体dom元素
				#container = null;
				
				// 选中物体的顺序下标
				#select_item_index = -1;
				
				// 是否关联到其他面板的开放和隐藏
				#is_related = false;
				constructor(container) {
					this.#container = container;
				}
				
				// 关联到下一个兄弟元素内面板的开放和隐藏
				relateToRear(is_true) {
					this.#is_related = is_true;
				}
				
				// 增加一个物体到指定顺序位置
				addItem(item, index) {
					if (this.isIndexValid(index)) {
						this.#container.insertBefore(item, this.#container.children[index]);
					}
					else {
						this.#container.appendChild(item);
					}
				}
				
				// 移除指定顺序下标的物体
				removeItem(index) {
					this.#container.removeChild(this.#container.children[index]);
					if (index == this.#select_item_index) {
						this.#select_item_index = -1;
					}
				}
				
				// 选中指定顺序下标的物体
				selectItem(index) {
					this.clearSelect();
					if (!this.isIndexValid(index)) {
						return;
					}
					this.#select_item_index = index;
					let item = this.#container.children[index];
					item.setAttribute("selected", "true");
				
					// 如果关联到其他面板的展示和隐藏，just do it
					// 否则，就到此为止
					if (!this.#is_related) {
						return;
					}
					let radio_index = item.getAttribute("radio-index");
					let parent = this.#container.nextElementSibling;
					for (let i = 0; i < parent.childElementCount; ++i) {
						if (i == radio_index) {
							parent.children[i].removeAttribute("style");
							continue;
						}
						parent.children[i].style.display = "none";
					}
				}
				
				// 获取指定顺序下标的dom元素
				getItem(index) {
					if (!this.isIndexValid(index)) {
						return null;
					}
					return this.#container.children[index];
				}
				
				// 查找指定物体的顺序下标，返回-1表示不含该物体
				getItemIndex(that) {
					if (that == null) {
						return -1;
					}
					else if (that.parentNode != this.#container) {
						return -1;
					}
					let temp = that;
					let index = 0;
					while (temp.previousElementSibling) {
						++index;
						temp = temp.previousElementSibling;
					}
					return index;
				}
				
				// 改变指定顺序下标index物体的顺序位置到new_index
				setItemIndex(index, new_index) {
					if (!this.isIndexValid(index)) {
						return -1;
					}
					let append = false;
					if (new_index < 0) {
						new_index = 0;
					}
					else if (new_index >= this.#container.childElementCount - 1) {
						new_index = this.#container.childElementCount - 1;
						append = true;
					}
					if (index == new_index) {
						return -1;
					}
					if (new_index > index) {
						++new_index;
					}
					if (!append) {
						this.#container.insertBefore(this.#container.children[index], this.#container.children[new_index]);
					}
					else {
						this.#container.appendChild(this.#container.children[index]);
					}
					if (new_index > index) {
						--new_index;
					}
					if (this.#select_item_index == index) {
						this.#select_item_index = new_index;
					}
					return new_index;
				}
				
				// 获得控制的本体dom元素
				getObject() {
					return this.#container;
				}
				
				// 获得子物体的数量
				getCount() {
					return this.#container.childElementCount;
				}
				
				// 清空选择
				clearSelect() {
					if (this.isIndexValid(this.#select_item_index)) {
						let former = this.#container.children[this.#select_item_index];
						former.removeAttribute("selected");
					}
					this.#select_item_index = -1;
				}
				
				// 清空数据
				clear() {
					this.clearSelect();
					while (this.#container.firstChild) {
						this.#container.lastChild.remove();
					}
				}
				isIndexValid(index) {
					if (isNaN(index) || index < 0 || index >= this.#container.childElementCount) {
						return false;
					}
					return true;
				}
			}
			
			// 渲染器
			class d_HTML2Canvas {
				// 调试信息输出开关
				static debug_mode = false;
				
				// 渲染用的画布
				#canvas = null;
				#context = null;
				
				// 是否正在工作中
				#working = false;
				
				// 输出参数选项的UI控制器
				#output_radio = [null, null, null];
				
				// 渲染参数
				#render_param = {
					method: 1,
					type: 1,
					head_index: -1,
					rear_index: -1,
					head_offset: 0,
					rear_offset: 0,
					scale: 1
				};
				
				// 渲染结果
				#output = new Array();
				constructor() {
					this.#canvas = document.createElement("canvas");
					this.#context = this.#canvas.getContext('2d');
					this.#output_radio[0] = new d_RadioPanel(document.getElementById("output_data_1"));
					this.#output_radio[0].selectItem(0);
					this.#output_radio[1] = new d_RadioPanel(document.getElementById("output_data_2"));
					this.#output_radio[1].relateToRear(true);
					this.#output_radio[1].selectItem(0);
					this.#output_radio[2] = new d_RadioPanel(document.getElementById("output_data_3"));
					this.#output_radio[2].relateToRear(true);
					this.#output_radio[2].selectItem(1);
				}
				
				// 开始渲染
				takeScreenshot() {
					if (d_HTML2Canvas.debug_mode) {
						this.debugLog("渲染参数：" + this.getRenderParameter());
					}
					if (this.#render_param.type < 0) {
						if (d_HTML2Canvas.debug_mode) {
							this.debugLog("输出设置有误，请检查参数");
						}
						return;
					}
					let time = new Date();
					if (d_HTML2Canvas.debug_mode) {
						this.debugLog("开始渲染 " + time);
					}
					
					// 渲染时不允许再次进行渲染
					// new Promise(function (resolve, reject) {
						if (this.#working) {
							if (d_HTML2Canvas.debug_mode) {
								this.debugLog("正在处理中，请稍后");
							}
							return;
						}
						this.#working = true;
						// resolve();
					// });
					
					// 调整输出尺寸
					if (isNaN(this.#render_param.scale)) {
						this.#render_param.scale = 1;
					}
					else if (this.#render_param.scale < 0.5) {
						this.#render_param.scale = 0.5;
					}
					else if (this.#render_param.scale > 8) {
						this.#render_param.scale = 8;
					}
					this.#output = new Array();
					let target = document.getElementById("container");
					this.#ensureRenderRange(target)
					let render_counter = [0, 0, 0];
					
					// 真的开始渲染
					this.#render(target.children[0].children[0], 8, render_counter, 0, 0);
					if (this.#render_param.type == 2) {
						this.#render(document.getElementById("container_head"), 8, render_counter, 0, this.#render_param.head_offset *  this.#render_param.scale);
					}
					
					// 结束，拿到结果
					let img = new Image();
					img.src = this.#canvas.toDataURL();
					img.style.width = (this.#canvas.width / this.#render_param.scale) + "px";
					img.style.height = (this.#canvas.height / this.#render_param.scale) + "px";
					this.#context.clearRect(0, 0, this.#canvas.width, this.#canvas.height);
					let finish_time = new Date();
					if (d_HTML2Canvas.debug_mode) {
						this.debugLog("完成渲染 " + finish_time);
						let str = "渲染耗时约 " + ((finish_time.getTime() - time.getTime()) / 1000) + " 秒，";
						str += "渲染物体 " + render_counter[1] + " 个";
						this.debugLog(str);
					}
					
					this.#output = [img];
					
					// 按用户想法反馈结果
					if (this.#render_param.method == 1) {
						let preview = document.getElementById("picture_preview");
						while (preview.firstChild) {
							preview.lastChild.remove();
						}
						for (let i = 0; i < this.#output.length; ++i) {
							preview.appendChild(this.#output[i]);
						}
					}
					else {
						for (let i = 0; i < this.#output.length; ++i) {
							let link = document.createElement("a");
							link.download = download_prefix + "Output" + new Date().getTime() + i.toString();
							link.href = this.#output[i].src;
							link.click();
							link.remove();
						}
					}
					
					// 工作结束
					this.#working = false;
				}
				
				// 设置渲染参数
				setRenderParameter(param) {
					// 不允许渲染的过程中修改渲染参数
					if (this.#working) {
						if (d_HTML2Canvas.debug_mode) {
							this.debugLog("正在处理中，请稍后");
						}
						return;
					}
					
					// 输出方式
					if (param[0] != null) {
						this.#render_param.method = param[0];
						this.#output_radio[0].selectItem(param[0] - 1);
					}
					
					// 渲染元素范围
					if (param[1] != null) {
						this.#render_param.type = param[1];
						if (this.#render_param.type == 4) {
							let index = getSelectItemIndex();
							if (index < 0) {
								this.#render_param.type = -4;
							}
						}
						this.#output_radio[1].selectItem(param[1] - 1);
					}
					
					// 渲染屏幕范围
					if (param[2] != null) {
						param[2] = parseInt(param[2]);
						let index = parseInt(getSelectItemIndex());
						let offset = this.#render_param.rear_index - this.#render_param.head_index;
						// type置负阻止进入渲染流程
						if (index < 0) {
							if (this.#render_param.type == 4) {
								this.#render_param.type = -4;
							}
							index = this.#render_param.head_index;
						}
						else {
							if (this.#render_param.type == -4) {
								this.#render_param.type = 4;
							}
							this.#render_param.head_index = index;
						}
						if (param[2] < 0) {
							this.#render_param.rear_index = index + offset;
						}
						else {
							this.#render_param.rear_index = index + param[2];
						}
					}
					
					// 渲染尺寸
					if (param[3] != null) {
						let scale = 1;
						if (param[3] == 1) {
							scale = 0.3;
						}
						else if (param[3] == 2) {
							scale = 1;
						}
						else if (param[3] == 3) {
							scale = 3;
						}
						else if (param[3] == 4) {
							scale = 8;
						}
						this.#render_param.scale = scale;
						this.#output_radio[2].selectItem(param[3] - 1);
					}
				}
				
				// 获取渲染参数
				getRenderParameter() {
					let res = "输出方式：";
					if (this.#render_param.method == 1) {
						res += "预览";
					}
					else {
						res += "下载";
					}
					
					res += "，渲染类型："
					if (this.#render_param.type == 1) {
						res += "一图流";
					}
					else if (this.#render_param.type == 2) {
						res += "屏幕";
					}
					else if (this.#render_param.type == 3) {
						res += "限制";
					}
					else if (this.#render_param.type == 4) {
						res += "多个";
					}
					else if (this.#render_param.type == -4) {
						res += "多个（未正确选择条目）";
					}
					res += "，从条目 " + this.#render_param.head_index + " 到条目 " + this.#render_param.rear_index;
					res += "，顶部 " + this.#render_param.head_offset + "，底部 " + this.#render_param.rear_offset;
					res += "，渲染尺寸：" + this.#render_param.scale + "x";
					return res;
				}
				
				// 确定渲染的范围
				// 比如从第二项开始渲染，那么初始位置就要减去第一项的高度
				#ensureRenderRange(target) {
					target = target.children[0].children[0];
					let head = 0;
					let rear = target.childElementCount - 1;
					
					// 一图流
					if (this.#render_param.type == 1) {
						this.#render_param.head_offset = target.children[head].offsetTop - 20;
						this.#render_param.rear_offset = target.children[rear].offsetTop + target.children[rear].offsetHeight + 20;
					}
					
					// 屏幕渲染
					else if (this.#render_param.type == 2 || this.#render_param.type == 3) {
						let index = 0;
						for (index = 0; index < target.childElementCount; ++index) {
							if (target.children[index].offsetTop + target.children[index].offsetHeight > target.parentNode.scrollTop) {
								break;
							}
						}
						this.#render_param.head_offset = target.parentNode.scrollTop - 2;
						let top_offset = document.getElementById("container_head").offsetHeight;
						if (this.#render_param.type == 3) {
							this.#render_param.head_offset += top_offset;
						}
						this.#render_param.rear_offset = this.#render_param.head_offset + target.parentNode.offsetHeight;
						if (this.#render_param.type == 3) {
							this.#render_param.rear_offset -= top_offset;
						}
					}
					
					// 渲染多个条目
					else if (this.#render_param.type == 4) {
						head = this.#render_param.head_index;
						if (rear > this.#render_param.rear_index) {
							rear = this.#render_param.rear_index;
						}
						this.#render_param.head_offset = target.children[head].offsetTop - 20;
						this.#render_param.rear_offset = target.children[rear].offsetTop + target.children[rear].offsetHeight + 20;
					}
					this.#canvas.width = target.offsetWidth * this.#render_param.scale;
					this.#canvas.height = (this.#render_param.rear_offset - this.#render_param.head_offset) * this.#render_param.scale;
					this.#context.fillStyle = "#eee";
					this.#context.fillRect(0, 0, this.#canvas.width, this.#canvas.height);
				}
				
				// 递归渲染所有物体
				#render(item, depth, counter, base_offset_x, base_offset_y) {
					if (depth <= 0) {
						this.debugLogError("终止渲染：递归深度异常");
						return false;
					}
					--depth;
					let style = window.getComputedStyle(item);
					if (style.display == "none") {
						return true;
					}
					let cal_offset = false;
					if (item.getAttribute("class") == "item") {
						cal_offset = true;
						let index = counter[2];
						++counter[2];
						if (d_HTML2Canvas.debug_mode) {
							this.debugLog(">>> 条目 " + counter[2]);
						}
						if (this.#render_param.type == 2 || this.#render_param.type == 3) {
							if (item.offsetTop + item.offsetHeight < this.#render_param.head_offset) {
								return true;
							}
							else if (item.offsetTop > this.#render_param.rear_offset) {
								return true;
							}
						}
						if (this.#render_param.type == 4) {
							if (index < this.#render_param.head_index || index > this.#render_param.rear_index) {
								return true;
							}
						}
					}
					else if(item.getAttribute("class") == "talk_container") {
						cal_offset = true;
					}
					let border_width = parseInt(style.borderWidth.slice(0, -2)) * this.#render_param.scale;
					if (cal_offset) {
						base_offset_x += (item.offsetLeft) * this.#render_param.scale;
						base_offset_y += (item.offsetTop) * this.#render_param.scale;
					}
					else {
						this.#renderItem(item, style, counter, [base_offset_x, base_offset_y - this.#render_param.head_offset * this.#render_param.scale]);
					}
					if (item.firstChild != null) {
						for (let i = 0; i < item.childElementCount; ++i) {
							if (!this.#render(item.children[i], depth, counter, base_offset_x + border_width, base_offset_y + border_width)) {
								return false
							}
						}
					}
					return true;
				}
				
				// 渲染物体
				#renderItem(item, style, counter, base_offset) {
					if (d_HTML2Canvas.debug_mode) {
						++counter[0];
						this.debugLog("检查元素……（" + counter[0] + "）");
					}
					let render_name = null;
					
					let x = base_offset[0] + item.offsetLeft * this.#render_param.scale;
					let y = base_offset[1] + item.offsetTop * this.#render_param.scale;
					let width = item.offsetWidth * this.#render_param.scale;
					let height = item.offsetHeight * this.#render_param.scale;
					let border_radius = parseInt(style.borderRadius.slice(0, -2)) * this.#render_param.scale;
					// let padding_left =  parseInt(style.paddingLeft.slice(0, -2));
					// let padding_top =  parseInt(style.paddingTop.slice(0, -2));
					
					let str = style.transform;
					let degree = 0;
					if (str != "none") {
						str = str.split('(')[1].slice(0, -1).split(',');
						degree = [parseFloat(str[0]), parseFloat(str[1])];
						degree = Math.atan2(degree[1], degree[0]);
					}
					
					str = style.backgroundColor;
					let has_background = false;
					if (str != "none") {
						str = str.split(',');
						if (str.length == 4) {
							str = parseFloat(str[3].slice(0, -1));
							if (str != 0) {
								has_background = true;
							}
						}
						else {
							has_background = true;
						}
					}
					
					if (this.#render_param.type == 2 && item.getAttribute("id") == "container_head") {
						this.#renderRect(x, y, width, height, border_radius, style.backgroundColor);
						render_name = "顶栏";
					}
					if (has_background && item.tagName.toLowerCase() != "input") {
						this.#renderRect(x, y, width, height, border_radius, style.backgroundColor, degree);
						render_name = "(" + x + "," + y + ") 色块";
					}
					if (item.firstElementChild == null && item.innerText != "") {
						let color = style.color;
						let font_size = style.fontSize;
						font_size = parseInt(font_size.slice(0, -2));
						font_size = font_size * this.#render_param.scale
						let font = style.fontWeight + " " + font_size + "px 微软雅黑";
						let line_height = parseInt(style.lineHeight.slice(0, -2)) * this.#render_param.scale;
						let letter_spacing = parseInt(style.letterSpacing.slice(0, -2));
						
						let offset = (line_height + font_size) / 2;
						// this.#renderRect(x, y, 10, 1, 0, "#f66", 0);
						y += offset + 2 * this.#render_param.scale;
						this.#renderText(item.innerText, x, y, font, color, style.textAlign, width, line_height, letter_spacing);
						render_name = "(" + x + "," + y + ") 文字：";
						if (item.innerText.length >= 7) {
							render_name += item.innerText.substr(0, 6) + "……";
						}
						else {
							render_name += item.innerText;
						}
					}
					if (item.tagName.toLowerCase() == "img") {
						this.#renderImage(item.src, x, y, width, height, border_radius);
						render_name = "(" + x + "," + y + ") 图片";
					}
					if (item.tagName.toLowerCase() == "input") {
						let color = "#000";
						let font_size = 26 * this.#render_param.scale;
						let font = style.fontWeight + " " + font_size + "px 微软雅黑";
						let line_height = 30 * this.#render_param.scale;
						let letter_spacing = parseInt(style.letterSpacing.slice(0, -2));
						
						let offset = (line_height + font_size) / 2;
						this.#renderText(item.value, x, y + offset, font, color, "center", width, line_height, 1);
						render_name = "(" + x + "," + y + ") 输入框";
					}
					// else if (item.parentNode.getAttribute("class") == "talk_container") {
					// 	if (item.getAttribute("bubble") != null) {
					// 		this.#renderRect(x, y, width, height, border_radius, style.backgroundColor);
					// 	}
					// 	render_name = "气泡";
					// }
					// else if (item.getAttribute("class") == "talk_icon") {
					// 	this.#renderImage(item.src, x, y, width, height, border_radius);
					// 	render_name = "头像";
					// }
					// else if (item.getAttribute("class") == "talk_name") {
					// 	this.#renderText(item.innerText, x, y + 6 * this.#render_param.scale, font, color, style.textAlign, width, line_height);
					// 	render_name = "昵称";
					// }
					// else if (item.getAttribute("class") == "talk_prefix") {
					// 	this.#renderRect(x, y, width, height, border_radius, style.backgroundColor, 45);
					// 	render_name = "气泡";
					// }
					// else if (item.getAttribute("content-type") == "text") {
					// 	this.#renderText(item.innerText, x, y + 6 * this.#render_param.scale, font, color, style.textAlign, width, line_height);
					// 	render_name = "聊天：";
					// 	if (item.innerText.length >= 7) {
					// 		render_name += item.innerText.substr(0, 6) + "……";
					// 	}
					// 	else {
					// 		render_name += item.innerText;
					// 	}
					// }
					// else if (item.getAttribute("content-type") == "image") {
					// 	this.#renderImage(item.src, x, y, width, height, border_radius);
					// 	render_name = "图像";
					// }
					// else if (item.parentNode.getAttribute("content-type") == "audio") {
					// 	this.#renderRect(x, y, width, height, border_radius, style.backgroundColor);
					// 	render_name = "音频符号";
					// }
					// else if (item.getAttribute("content-type") == "audio_translate") {
					// 	this.#renderText(item.innerText, x, y + 6 * this.#render_param.scale, font, color, style.textAlign, width, line_height);
					// 	render_name = "语音转文字";
					// }
					
					if (d_HTML2Canvas.debug_mode && render_name != null) {
						++counter[1];
						this.debugLog("已渲染 " + render_name + "（" + counter[1] + "）");
					}
				}
				
				// 渲染矩形
				#renderRect(x, y, width, height, radius, color, deg) {
					let ctx = this.#context;
					ctx.fillStyle = color;
					this.#drawBaseRect(ctx, x, y, width, height, radius, deg);
					ctx.fill();
				}
				
				// 渲染文字
				#renderText(text, x, y, font, color, align, line_width, line_height, letter_spacing) {
					let ctx = this.#context;
					ctx.font = font;
					ctx.fillStyle = color;
					ctx.textBaseline = "ideographic";
					let text_line = "";
					let cur_length = 0;
					let cur_height = 0;
					let align_offset = 0;
					let increase = 0;
					for (let i = 0; i < text.length; ++i) {
						increase = ctx.measureText(text[i]).width;
						// 如果再加一个字就超了，将这行字进行渲染
						if (cur_length + increase >= line_width || text[i] == '\n') {
							if (align == "center") {
								align_offset = (line_width - cur_length) / 2;
							}
							cur_length = 0;
							for (let j = 0; j < text_line.length; ++j) {
								ctx.fillText(text_line[j], x + cur_length + align_offset, y + cur_height);
								increase = ctx.measureText(text_line[j]).width + letter_spacing * this.#render_param.scale;
								cur_length += increase;
							}
							text_line = "";
							cur_length = 0;
							cur_height += line_height;
						}
						if (text[i] != '\n') {
							text_line += text[i];
							cur_length += increase + letter_spacing * this.#render_param.scale;
						}
					}
					if (align == "center") {
						align_offset = (line_width - cur_length) / 2;
					}
					cur_length = 0;
					for (let j = 0; j < text_line.length; ++j) {
						ctx.fillText(text_line[j], x + cur_length + align_offset, y + cur_height);
						increase = ctx.measureText(text_line[j]).width + letter_spacing * this.#render_param.scale;
						cur_length += increase;
					}
				}
				
				// 渲染图像
				#renderImage(path, x, y, width, height, radius) {
					let ctx = this.#context;
					let img = new Image();
					let _object = this;
					img.src = path;
					img.onload = new Promise(function(resolve, reject) {
						ctx.save()
						_object.#drawBaseRect(ctx, x, y, width, height, radius);
						ctx.clip();
						ctx.drawImage(img, x, y, width, height);
						ctx.restore()
						resolve();
					});
					return;
				}
				
				// 绘制圆角矩形路径
				#drawBaseRect(ctx, x, y, width, height, radius, deg) {
					if (radius > width / 2) {
						radius = width / 2;
					}
					if (radius > height / 2) {
						radius = height / 2;
					}
					let points = [
						[x + radius, y],
						[x + width - radius, y],
						[x + width, y],
						[x + width, y + radius],
						[x + width, y + height - radius],
						[x + width, y + height],
						[x + width - radius, y + height],
						[x + radius, y + height],
						[x, y + height],
						[x, y + height - radius],
						[x, y + radius],
						[x, y],
						[x + radius, y]
					];
					if (deg != null && deg != 0) {
						// deg = deg / 180 * Math.PI;
						let mid_x = x + width / 2;
						let mid_y = y + height / 2;
						for (let loop = 0; loop < points.length; ++loop) {
							let x = points[loop][0];
							let y = points[loop][1];
							points[loop][0] = (x - mid_x) * Math.cos(deg) - (y - mid_y) * Math.sin(deg) + mid_x;
							points[loop][1] = (x - mid_x) * Math.sin(deg) + (y - mid_y) * Math.cos(deg) + mid_y;
						}
					}
					ctx.beginPath();
					ctx.moveTo(points[0][0], points[0][1]);
					for (let loop = 1; loop < points.length; loop += 3) {
						ctx.lineTo(points[loop][0], points[loop][1]);
						ctx.arcTo(points[loop + 1][0], points[loop + 1][1], points[loop + 2][0], points[loop + 2][1], radius);
					}
					ctx.closePath();
					return ctx;
				}
				debugLog(str) {
					console.log("[HTML2Canvas] " + str);
				}
				debugLogError(str) {
					console.error("[HTML2Canvas] " + str);
				}
			}
			class d_VersionPublicity {
				#thread = null;
				#splash_timer = 0;
				#splash_stage = 0;
				#splash_percent = 0;
				#splash_introduction = null;
				constructor() {
					let _instance = this;
					console.log(this);
					this.#splash_stage = 1;
					this.#splash_introduction = document.getElementById("splash_introduction");
					this.#splash_timer = new Date().getTime();
					this.#splash_introduction.setAttribute("stage", this.#splash_stage);
					this.#thread = setInterval(function() {
						_instance.#playSplashIntroduction();
					}, 10);
				}
				#playSplashIntroduction() {
					console.log(1)
					let time = new Date().getTime();
					if (this.#splash_stage == 1) {
						this.#splash_percent = (time - this.#splash_timer) / 4000;
					}
					else if (this.#splash_stage == 2) {
						this.#splash_percent = (time - this.#splash_timer) / 4000;
					}

					if (this.#splash_percent >= 1) {
						++this.#splash_stage;
						this.#splash_introduction.setAttribute("stage", this.#splash_stage);
						this.#splash_timer = time;
					}
					if (this.#splash_stage >= 3) {
						clearInterval(this.#thread);
						this.#thread = null;
						this.#splash_introduction.remove();
					}
				}
			}
			function collapse_node(that) {
				that.parentNode.nextElementSibling.style.display = "none";
				that.setAttribute("onclick", "expand_node(this)");
				that.innerText = "+";
			}
			function expand_node(that) {
				that.parentNode.nextElementSibling.style.display = null;
				that.setAttribute("onclick", "collapse_node(this)");
				that.innerText = "-";
			}
			function setSelectItemIndex() {
				return output_tool.setRenderParameter([null, null, -1, null]);
			}
			function getSelectItemIndex() {
				return control_panel.getSelectItemIndex();
			}
			function setContainerPosition(left, right) {
				let container = document.getElementById("container");
				if (left == null) {
					container.style.marginLeft = "auto";
				}
				else {
					container.style.marginLeft = left + "px";
				}
				if (right == null) {
					container.style.marginRight = "auto";
				}
				else {
					container.style.marginRight = right + "px";
				}
			}
			function setContainerType(type) {
				let container = document.getElementById("container");
				let container_content = document.getElementById("container_content");
				if (type == 1) {
					container_content.setAttribute("class", "scroll_container");
					container.setAttribute("type", "limited");
				}
				else {
					container.removeAttribute("type");
					container_content.removeAttribute("class");
				}
			}
			function switch_debug_mode(index, that) {
				let is_true = true;
				if (index == 1) {
					d_Database.debug_mode = !d_Database.debug_mode;
					is_true = d_Database.debug_mode;
					if (is_true) {
						document.getElementById("database").style.display = "initial";
						document.getElementById("database").style.wordBreak = "break-all";
					}
					else {
						document.getElementById("database").style.display = "none";
						document.getElementById("database").style.wordBreak = "break-all";
					}
				}
				else if (index == 2) {
					d_ControlPanel.debug_mode = !d_ControlPanel.debug_mode;
					is_true = d_ControlPanel.debug_mode;
				}
				else if (index == 3) {
					d_ViewPanel.debug_mode = !d_ViewPanel.debug_mode;
					is_true = d_ViewPanel.debug_mode;
				}
				else if (index == 4) {
					d_HTML2Canvas.debug_mode = !d_HTML2Canvas.debug_mode;
					is_true = d_HTML2Canvas.debug_mode;
				}
				if (is_true) {
					that.setAttribute("selected", true);
					console.log("开启控制台输出");
				}
				else {
					that.removeAttribute("selected");
					console.log("关闭控制台输出");
				}
			}
		</script>
	</head>
	<body style="background-color: #fff;" onclick="if (event.target == event.currentTarget) control_panel.clearSelect()">
		<div id="container">
			<div id="container_content"><div onclick="if (event.target == event.currentTarget) control_panel.clearSelect()"></div></div>
			<div id="container_head"><input style="text-align: center;" type="text" value="名称" /></div>
		</div>
		<div id="picture_preview"></div>
		<div id="template" style="display: none;">
			<div class="item" type=1 onclick="control_panel.selectItem(this)" side="left">
				<img class="talk_icon" />
				<div class="talk_prefix"></div>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div bubble><div content-type="text">编辑文字</div></div>
				</div>
			</div>
			<div class="item" type=2 onclick="control_panel.selectItem(this)" side="right">
				<img class="talk_icon" />
				<div class="talk_prefix"></div>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div bubble><div content-type="text">编辑文字</div></div>
				</div>
			</div>
			<div class="item" type=3 onclick="control_panel.selectItem(this)" side="mid">
				<div class="talk_container">
					<div><div content-type="text">编辑文字</div></div>
				</div>
			</div>
			<div class="item" type=4 onclick="control_panel.selectItem(this)" side="left">
				<img class="talk_icon"></img>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div><img content-type="image" /></div>
				</div>
			</div>
			<div class="item" type=5 onclick="control_panel.selectItem(this)" side="right">
				<img class="talk_icon"></img>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div><img content-type="image" /></div>
				</div>
			</div>
			<div class="item" type=6 onclick="control_panel.selectItem(this)" side="mid">
				<div class="talk_container">
					<div><img content-type="image" /></div>
				</div>
			</div>
			<div class="item" type=7 onclick="control_panel.selectItem(this)" side="left">
				<img class="talk_icon" />
				<div class="talk_prefix"></div>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div bubble><div content-type="audio"><div></div></div><div content-type="text">1"</div></div><br />
					<div bubble><div content-type="audio_translate">编辑翻译</div></div>
				</div>
			</div>
			<div class="item" type=8 onclick="control_panel.selectItem(this)" side="right">
				<img class="talk_icon" />
				<div class="talk_prefix"></div>
				<div class="talk_name">未命名</div>
				<div class="talk_container">
					<div bubble><div content-type="audio"><div></div></div><div content-type="text">1"</div></div><br />
					<div bubble><div content-type="audio_translate">编辑翻译</div></div>
				</div>
			</div>
			<div class="item" type=8 onclick="control_panel.selectItem(this)" side="mid">
				<div class="talk_container">
					<div><div content-type="audio"><div></div></div><div content-type="text">1"</div></div>
				</div>
			</div>
		</div>
		<div id="control" type=0>
			<div draggable="true" style="width: 32px; height: 32px; background-color: #fb2; border-radius: 20px; position: absolute; left: -16px; top: -16px; cursor: move;"></div>
			<div id="control_container" class="scroll_container">
				<h3 id="debug_panel" style="background-color: #fffa; position: absolute; overflow: hidden;">未在编辑</h3>
				<hr style="margin: 80px 0 0; border: #fb2 1px solid;" />
				<h2>常规</h2>
				<div style="width: 100%;">
					<h3>编辑<button onclick="collapse_node(this)">-</button></h3>
					<div>
						<p>角色</p>
						<div class="scroll_container" style="width: 100%; min-height: 50px; max-height: 400px;">
							<p>未添加角色</p>
							<ul id="char_case" class="char_case"></ul>
						</div>
						<p>内容</p>
						<ul id="data_item_type_input" class="button_list">
							<li onclick="control_panel.setItemType(this, 1)" radio-index=0 selected>左文字</li>
							<li onclick="control_panel.setItemType(this, 2)" radio-index=0>右文字</li>
							<li onclick="control_panel.setItemType(this, 3)" radio-index=0>旁白</li>
							<li onclick="control_panel.setItemType(this, 4)" radio-index=1>左图片</li>
							<li onclick="control_panel.setItemType(this, 5)" radio-index=1>右图片</li>
							<li onclick="control_panel.setItemType(this, 6)" radio-index=1>场景图片</li>
							<li onclick="control_panel.setItemType(this, 7)" radio-index=1>左语音</li>
							<li onclick="control_panel.setItemType(this, 8)" radio-index=1>右语音</li>
						</ul>
						<div>
							<div>
								<textarea id="data_text_input" onchange="control_panel.setItemData([null, this.value, null])"></textarea>
							</div>
							<div style="display: none;">
								<input id="data_image_path_input" onchange="control_panel.setItemData([null, this.value, null])" type="text" />
								<input id="data_size_input" onchange="control_panel.setItemData([null, null, this.value])" type="number" value="0" />
								<img style="width: 60px; height: 60px; vertical-align: middle;">
								<p style="color: #999; font-size: 18px;">1.编辑图片时，第一个输入框用于编辑图片路径（路径为./img/+此框输入内容，需要带上图片格式），第二个输入框用于编辑图片大小（推荐整数，<50不生效)</p>
								<p style="color: #999; font-size: 18px;">2.编辑语音时，第一个输入框用于编辑语音转文字内容，第二个输入框用于编辑语音时长（整数，单位秒，0~300）</p>
							</div>
						</div>
						<p>操作</p>
						<ul class="button_list">
							<li onclick="control_panel.addItem()">发送</li>
							<li onclick="control_panel.changeItemIndex(-1)">上移一项</li>
							<li onclick="control_panel.changeItemIndex(1)">下移一项</li>
							<li onclick="control_panel.removeItem()">删除此项</li>
						</ul>
						<p>视图位置</p>
						<ul class="button_list">
							<li onclick="setContainerPosition(20, null)">左</li>
							<li onclick="setContainerPosition(200, null)">偏左</li>
							<li onclick="setContainerPosition(null, null)">中</li>
							<li onclick="setContainerPosition(null, 200)">偏右</li>
							<li onclick="setContainerPosition(null, 20)">右</li>
						</ul>
						<p>模拟</p>
						<ul class="button_list">
							<li onclick="setContainerType(0)">无</li>
							<li onclick="setContainerType(1)">屏幕模拟</li>
						</ul>
					</div>
					<h3>角色<button onclick="expand_node(this)">+</button></h3>
					<div style="display: none;">
						<p>操作</p>
						<ul class="button_list">
							<li onclick="control_panel.addCharacter(null, true)">增加</li>
							<li onclick="control_panel.removeCharacter(true)">删除</li>
						</ul>
						<p>头像（路径为./img/下）</p>
						<input id="data_char_path_input" onchange="control_panel.setCharacterData([this.value, null], true)" type="text" />
						<img style="width: 60px; height: 60px; vertical-align: middle;">
	<!-- 					<p>添加方式二（不推荐）</p>
						<input id="char_file" type="file" /> -->
						<p>名称</p>
						<input id="data_char_name_input" onchange="control_panel.setCharacterData([null, this.value], true)" type="text" />
					</div>
					<h3>数据<button onclick="expand_node(this)">+</button></h3>
					<div style="display: none;">
						<p>导出</p>
						<ul class="button_list">
							<li onclick="database.exportData()">下载数据</li>
						</ul>
						<p>导入</p>
						<ul class="button_list">
							<input onchange="database.importDataFromFile(this);" type="file" />
						</ul>
						<p>临时储存</p>
						<ul class="button_list">
							<li onclick="database.importData(localStorage.getItem('el_data')); control_panel.loadData();">从localStorage中载入数据</li>
							<li onclick="if (confirm('确认清除数据？')) {if (confirm('确认清除数据？')) localStorage.removeItem('el_data')}">清空localStorage数据</li>
						</ul>
						<p style="color: #999; font-size: 18px;">注意：localStorage存储仅供<b>不小心关闭网页或刷新网页</b>后进行数据恢复，请使用 常规>数据>导出>下载数据 进行保存</p>
					</div>
					<h3>输出<button onclick="expand_node(this)">+</button></h3>
					<div style="display: none;">
						<p>方式</p>
						<ul id="output_data_1" class="button_list">
							<li onclick="output_tool.setRenderParameter([1, null, null, null])">预览</li>
							<li onclick="output_tool.setRenderParameter([2, null, null, null])">下载</li>
						</ul>
						<p>截断</p>
						<ul id="output_data_2" class="button_list">
							<li onclick="output_tool.setRenderParameter([null, 1, null, null])" radio-index=-1 selected>一图流</li>
							<li onclick="output_tool.setRenderParameter([null, 2, null, null])" radio-index=0>当前屏幕</li>
							<li onclick="output_tool.setRenderParameter([null, 3, null, null])" radio-index=0>当前屏幕，仅内容</li>
							<li onclick="output_tool.setRenderParameter([null, 4, null, null])" radio-index=1>多个</li>
						</ul>
						<div>
							<div>
								<p style="color: #999; font-size: 18px;">在 常规>编辑 内开启“屏幕模拟”</p>
							</div>
							<div style="display: none;">
								<span style="margin-left: 16px; font-size: 18px; color: #666;">数量：</span>
								<input onchange="output_tool.setRenderParameter([null, null, this.value, null])" type="number" value="0" />
								<p style="color: #999; font-size: 18px;">输出包含当前选中条目在内的指定数量的条目，向下计数</p>
								<p style="color: #999; font-size: 18px;">（一时间没想到怎么描述，不知道有没有建议）</p>
							</div>
						</div>
						<p>尺寸（数字越大图片越大，缩小到小尺寸越清晰）</p>
						<ul id="output_data_3" class="button_list">
							<li onclick="output_tool.setRenderParameter([null, null, null, 1])" radio-index=0>0.3x（不推荐）</li>
							<li onclick="output_tool.setRenderParameter([null, null, null, 2])" radio-index=1 selected>1x</li>
							<li onclick="output_tool.setRenderParameter([null, null, null, 3])" radio-index=-1>3x</li>
							<li onclick="output_tool.setRenderParameter([null, null, null, 4])" radio-index=2>8x（不推荐）</li>
						</ul>
						<div>
							<div style="display: none;">
								<p style="color: #999; font-size: 18px;">选这个，真不是整活吗？</p>
							</div>
							<div>
								<p style="color: #999; font-size: 18px;">有时候图片会有锯齿感，如有，请选后一个</p>
							</div>
							<div style="display: none;">
								<p style="color: #999; font-size: 18px;">请注意：这可能花费很长时间</p>
							</div>
						</div>
						<p>最后<span style="font-size: 14px; color: #0002;">，雨停了，让我们</span></p>
						<ul class="button_list">
							<li onclick="output_tool.takeScreenshot()">开始<span style="font-size: 14px; color: #0002;">吧</span></li>
						</ul>
					</div>
					<h3>开发者<button onclick="expand_node(this)">+</button></h3>
					<div style="display: none;">
						<p id="version_info" style="margin: 0 10px;">嗯聊v2.0.0</p>
						<p style="margin: 0 10px;">于2024.5.16</p>
						<p style="margin: 0 10px; user-select: text;">@WDDDDD</p>
						<p style="margin: 0 10px 20px;; user-select: text;"><a href="https://github.com/hyacinthlet/ToughTalk.git" target="_blank" style="color: #fb2">前往github</a></p>
						<p style="margin: 0 10px;">其他链接</p>
						<p style="margin: 0 10px 20px;; user-select: text;">百度贴吧：<a href="https://tieba.baidu.com/p/9017914820" target="_blank" style="color: #fb2">https://tieba.baidu.com/p/9017914820</a></p>
						<p style="margin: 0 10px 20px;">修改后请保留版权说明</p>
						<ul class="button_list">
							<li onclick="switch_debug_mode(1, this)">数据库debug模式</li>
							<li onclick="switch_debug_mode(2, this)">控制面板debug模式</li>
							<li onclick="switch_debug_mode(3, this)">视图debug模式</li>
							<li onclick="switch_debug_mode(4, this)">渲染debug模式</li>
						</ul>
						<div id="database" style="display: none; word-wrap: break-all; user-select: text;"></div>
					</div>
				</div>
			</div>
		</div>
		<div id="splash_introduction">
			<p style="font-weight: bold; margin: 0; text-align: center;">
				<span style="letter-spacing: 24px;">嗯聊<span style="letter-spacing: 0;">2.0</span></span>
				
			</p>
			<p style="font-weight: bold; margin: 0; text-align: center;">
				<span style="letter-spacing: 4px;">Tough Talk<span style="letter-spacing: 0; margin-left: 24px;">2.0</span></span>
			</p>
		</div>
	</body>
</html>
